<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://i.imgur.com/MhJTp8K.png" type="image/png">
    <title>M√≥j Profil - Exsi3D</title>
    
    <style>
        /* CSS NAWIGACJI */
        body { margin: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;}
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 50px; background-color: white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .logo img { height: 60px; display: block; }
        .nav-links ul { list-style: none; padding: 0; margin: 0; display: flex; }
        .nav-links li { margin-left: 25px; position: relative; }
        .nav-links a { text-decoration: none; color: #333; font-weight: bold; font-size: 14px; padding: 10px 0; display: inline-block; transition: color 0.2s; }
        .icons-group { display: flex; align-items: center; gap: 20px; }
        .account-icon { position: relative; cursor: pointer; font-size: 24px; }
        .account-img { height: 30px; width: 30px; border-radius: 50%; display: block; }
        .account-dropdown {
            position: absolute; top: 100%; right: 0; background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-radius: 4px; padding: 10px 0;
            min-width: 150px; z-index: 30; display: none;
        }
        .account-dropdown a { display: block; padding: 8px 15px; text-decoration: none; color: #333; font-size: 14px; font-weight: normal; }
        .account-dropdown a:hover { background-color: #f4f4f4; color: #007bff; }
        .account-dropdown.visible { display: block; }
        .cart { font-size: 24px; position: relative; cursor: pointer; }
        .cart-count { 
            position: absolute; top: -8px; right: -10px; background-color: red; color: white;
            border-radius: 50%; padding: 2px 6px; font-size: 10px; font-weight: bold; line-height: 1; border: 2px solid white;
            display: none;
        }

        /* STYLE NOTYFIKACJI */
        .notification {
            visibility: hidden; min-width: 250px; background-color: #4CAF50; color: white;
            text-align: center; border-radius: 2px; padding: 16px; position: fixed;
            z-index: 200; left: 50%; bottom: 30px; transform: translateX(-50%);
            font-size: 17px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transition: opacity 0.5s linear; opacity: 0;
        }
        .notification.show { visibility: visible; opacity: 1; }
        .notification.error { background-color: #f44336; }

        /* MODALE */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888;
            width: 90%; max-width: 500px; border-radius: 8px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px;}
        .close-btn:hover { color: #333; cursor: pointer; }
        .modal-content h2 { text-align: center; margin-bottom: 20px; }
        
        .modal-content form input:not([type="file"]), .modal-content form select, .modal-content form textarea {
             width: 100%; padding: 10px; margin: 8px 0 15px 0; border: 1px solid #ccc; box-sizing: border-box; border-radius: 4px;
        }
        
        .modal-content form button { 
            background-color: #007bff; color: white; padding: 12px 20px; margin: 10px 0; 
            border: none; cursor: pointer; width: 100%; border-radius: 4px; font-size: 16px; 
        }
        .modal-content form button:hover { background-color: #0056b3; }
        .error-message { color: red; font-size: 12px; margin-top: -10px; text-align: center; }

        /* PROFIL */
        .profile-container {
            max-width: 600px; margin: 40px auto; padding: 30px;
            background-color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .profile-header { display: flex; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .profile-picture-container {
            position: relative; width: 100px; height: 100px; cursor: pointer; margin-right: 20px;
        }
        #profile-photo {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 3px solid #007bff; transition: border-color 0.2s;
        }
        #profile-photo:hover { border-color: #0056b3; }
        .profile-info { text-align: left; }
        #profile-username { font-size: 24px; font-weight: bold; margin: 0; color: #333; }
        #profile-email { font-size: 14px; color: #777; margin: 0; }

        /* PRZYCISKI PROFILU */
        .action-button {
            width: 100%; padding: 15px; margin: 10px 0; background-color: #f4f4f4;
            color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;
            font-size: 16px; font-weight: bold; text-align: left;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .action-button:hover { background-color: #eee; border-color: #ccc; }
        
        #admin-panel-btn { background-color: #ffc107; color: #333; border-color: #ffc107; text-align: center; }
        #admin-panel-btn:hover { background-color: #e0a800; border-color: #e0a800; }
        
        #discount-codes-btn { background-color: #28a745; color: white; border-color: #28a745; text-align: center; }
        #discount-codes-btn:hover { background-color: #218838; border-color: #218838; }
        
        .admin-form-selector {
            display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;
        }
        .admin-form-selector button {
            background-color: #ddd; color: #333; border: 1px solid #ccc;
            padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;
            transition: background-color 0.2s; width: 100%;
        }
        .admin-form-selector button.active {
            background-color: #007bff; color: white; border-color: #007bff;
        }
        .admin-form-selector button:hover:not(.active) { background-color: #eee; }

        .logout-section { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }

        /* PANEL ADMINA - PRODUKTY */
        .admin-form-group { margin-bottom: 15px; }
        
        .color-input-group {
            display: flex; gap: 10px; margin-bottom: 15px;
            background-color: #f5f5f5; padding: 10px; border-radius: 4px;
        }
        .color-input-group input { 
            margin: 0; flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;
        }
        .color-input-group button { 
            width: 100px; background-color: #4CAF50; color: white; border-radius: 4px;
            padding: 8px 10px; margin: 0; font-size: 14px; flex-shrink: 0; border: none; cursor: pointer;
        }
        .color-input-group button:hover { background-color: #45a049; }
        
        #color-list, #image-upload-list { list-style: none; padding: 0; margin-top: 10px; }
        #color-list li, #image-upload-list li {
            background-color: #f9f9f9; padding: 8px; border-radius: 4px; 
            margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;
        }
        .remove-color-btn { 
            background-color: #dc3545; color: white; border: none; 
            padding: 4px 8px; border-radius: 3px; cursor: pointer;
        }
        
        .image-upload-item img {
            width: 50px; height: 50px; object-fit: cover; border: 1px solid #ddd; margin-right: 10px;
        }
        .image-upload-item {
            display: flex; align-items: center; padding: 10px;
            background: #f9f9f9; border-radius: 4px; margin-bottom: 10px;
        }
        .image-upload-item label { margin: 0; font-weight: bold; min-width: 100px; }
        .image-upload-item input[type="file"] {
            flex-grow: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; background: white;
        }
        
        #product-management-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        #product-management-list li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid #eee; background: white;
        }
        #product-management-list li:hover { background-color: #f0f8ff; }
        .product-actions button {
            margin-left: 5px; padding: 6px 12px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 14px; font-weight: bold;
        }
        .edit-product-btn { background-color: #ffc107; color: #333; }
        .edit-product-btn:hover { background-color: #e0a800; }
        .remove-product-btn { background-color: #dc3545; color: white; }
        .remove-product-btn:hover { background-color: #c82333; }
        
        /* MODAL EDYCJI PRODUKTU */
        #edit-product-modal .modal-content { max-width: 700px; max-height: 80vh; overflow-y: auto; }
        .edit-color-item {
            display: flex; align-items: center; gap: 15px; margin-bottom: 15px;
            padding: 15px; background: #f8f9fa; border-radius: 8px;
        }
        .edit-color-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .edit-color-info { flex-grow: 1; }
        .edit-color-name { font-weight: bold; margin-bottom: 5px; }
        .edit-color-actions { display: flex; gap: 10px; align-items: center; }
        .remove-color-edit-btn { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .add-new-color-btn { background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin: 10px 0; }

        /* STYLE KOD√ìW RABATOWYCH */
        .discount-code-item {
            background: white; border: 1px solid #ddd; border-radius: 8px;
            padding: 15px; margin-bottom: 10px; transition: box-shadow 0.2s;
        }
        .discount-code-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .discount-code-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .discount-code-name {
            font-size: 18px; font-weight: bold; color: #333; background: #f0f8ff;
            padding: 5px 10px; border-radius: 4px; letter-spacing: 1px;
        }
        .discount-code-discount {
            font-size: 20px; font-weight: bold; color: #28a745;
        }
        .discount-code-details {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; margin-bottom: 10px; font-size: 14px; color: #555;
        }
        .discount-code-detail { display: flex; align-items: center; }
        .discount-code-detail i { margin-right: 5px; color: #007bff; }
        .discount-code-actions { display: flex; gap: 10px; margin-top: 10px; }
        .discount-code-status {
            display: inline-block; padding: 3px 8px; border-radius: 12px;
            font-size: 12px; font-weight: bold; margin-left: 10px;
        }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-inactive { background-color: #f8d7da; color: #721c24; }
        .status-expired { background-color: #fff3cd; color: #856404; }
        .status-used { background-color: #e2e3e5; color: #383d41; }
        .code-usage-bar {
            height: 5px; background: #e9ecef; border-radius: 3px; margin-top: 5px; overflow: hidden;
        }
        .code-usage-fill {
            height: 100%; background: #28a745; border-radius: 3px; transition: width 0.3s;
        }
        .edit-code-btn, .remove-code-btn {
            padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;
            font-size: 14px; font-weight: bold;
        }
        .edit-code-btn { background-color: #ffc107; color: #333; }
        .remove-code-btn { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <header class="navbar">
        <a href="index.html" class="logo">
            <img src="https://i.imgur.com/MhJTp8K.png" alt="Logo Exsi3D">
        </a>
        <nav class="nav-links">
            <ul>
                <li><a href="index.html">STRONA G≈Å√ìWNA</a></li>
                <li class="dropdown" id="dropdown-parent">
                    <a href="shop.html" id="products-link">PRODUKTY <span class="arrow-down"></span> </a>
                    <ul class="dropdown-menu" id="dropdown-menu">
                        <li><a href="shop.html?category=przedmioty">Przedmioty</a></li>
                        <li><a href="shop.html?category=gad≈ºety">Gad≈ºety</a></li>
                    </ul>
                </li>
                <li><a href="#">KONTAKT</a></li>
            </ul>
        </nav>
        <div class="icons-group">
            <div class="account-icon" id="account-icon">
                <img id="nav-profile-photo" src="image_2245d8.png" alt="Konto U≈ºytkownika" class="account-img">
                <div class="account-dropdown" id="account-dropdown">
                    <a href="index.html" id="login-link" class="state-logged-out">Zaloguj siƒô</a>
                    <a href="index.html" id="register-link" class="state-logged-out">Zarejestruj siƒô</a>
                    <a href="profile.html" id="profile-link" class="state-logged-in" style="display: none;">Profil</a>
                    <a href="#" id="logout-nav-link" class="state-logged-in" style="display: none;">Wyloguj</a>
                </div>
            </div>
            <div class="cart" onclick="window.location.href='shop.html?view=cart'">
                üõí
                <span class="cart-count">0</span>
            </div>
        </div>
    </header>

    <!-- PROFIL -->
    <main>
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-picture-container">
                    <img id="profile-photo" src="image_2245d8.png" alt="Zdjƒôcie Profilowe">
                    <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
                </div>
                <div class="profile-info">
                    <h2 id="profile-username">Nazwa U≈ºytkownika</h2>
                    <p id="profile-email">email@example.com</p>
                </div>
            </div>

            <button class="action-button" id="change-password-btn">Zmie≈Ñ Has≈Ço</button>
            <button class="action-button" id="change-email-btn">Zmie≈Ñ Adres E-mail</button>
            <button class="action-button" id="admin-panel-btn" style="display: none;">Panel Admina</button>
            <button class="action-button" id="discount-codes-btn" style="display: none;">Kody Rabatowe</button>
            <button class="action-button" id="delete-account-btn" style="background-color: #dc3545; color: white;">Usu≈Ñ Konto</button>

            <div class="logout-section">
                <button class="action-button" id="logout-center-link" style="width: auto; padding: 10px 30px;">Wyloguj</button>
            </div>
        </div>
    </main>
    
    <!-- MODALE PROFILU -->
    <div class="modal" id="password-modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-btn" id="close-password-modal">&times;</span>
            <h2>Zmie≈Ñ Has≈Ço</h2>
            <form id="password-form">
                <label for="current-pass">Bie≈ºƒÖce Has≈Ço</label>
                <input type="password" id="current-pass" required>
                <label for="new-pass">Nowe Has≈Ço (min. 8 znak√≥w)</label>
                <input type="password" id="new-pass" required>
                <label for="new-pass-confirm">Potwierd≈∫ Nowe Has≈Ço</label>
                <input type="password" id="new-pass-confirm" required>
                <p class="error-message" id="password-error"></p>
                <button type="submit">Zmie≈Ñ Has≈Ço</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="email-modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-btn" id="close-email-modal">&times;</span>
            <h2>Zmie≈Ñ Adres E-mail</h2>
            <form id="email-form">
                <label for="current-email">Bie≈ºƒÖcy E-mail</label>
                <input type="email" id="current-email" required disabled>
                <label for="new-email">Nowy Adres E-mail</label>
                <input type="email" id="new-email" required>
                <label for="email-pass">Has≈Ço do potwierdzenia</label>
                <input type="password" id="email-pass" required>
                <p class="error-message" id="email-error"></p>
                <button type="submit">Zmie≈Ñ E-mail</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="confirm-modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <span class="close-btn" id="close-confirm-modal">&times;</span>
            <h2>Potwierd≈∫ Usuniƒôcie Konta</h2>
            <p>Czy na pewno chcesz usunƒÖƒá swoje konto? Tej operacji nie mo≈ºna cofnƒÖƒá.</p>
            <p class="error-message" id="confirm-error"></p>
            <button id="confirm-delete-btn" style="background-color: #dc3545; margin-bottom: 10px;">Tak, usu≈Ñ konto</button>
            <button id="cancel-delete-btn" style="background-color: #6c757d;">Anuluj</button>
        </div>
    </div>
    
    <!-- PANEL ADMINA - PRODUKTY -->
    <div class="modal" id="admin-panel-modal">
        <div class="modal-content" style="max-width: 700px; text-align: left;">
            <span class="close-btn" id="close-admin-panel">&times;</span>
            <h2 id="admin-panel-title">Panel Admina: ZarzƒÖdzanie Produktami</h2>
            
            <div class="admin-form-selector">
                <button type="button" id="add-product-tab" class="active">Dodaj Produkt</button>
                <button type="button" id="manage-products-tab">ZarzƒÖdzaj Produktami</button>
            </div>
            
            <div id="add-product-section" style="display: block;">
                <form id="product-data-form">
                    <h3>1. Podstawowe Dane</h3>
                    <div class="admin-form-group">
                        <label for="product-category">Kategoria</label>
                        <select id="product-category" required>
                            <option value="">Wybierz kategoriƒô</option>
                            <option value="przedmioty">Przedmioty</option>
                            <option value="gad≈ºety">Gad≈ºety</option>
                        </select>
                    </div>
                    <div class="admin-form-group">
                        <label for="product-name">Nazwa Produktu</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="admin-form-group">
                        <label for="product-price">Cena (z≈Ç)</label>
                        <input type="number" id="product-price" min="0.01" step="0.01" required>
                    </div>
                    <div class="admin-form-group">
                        <label for="product-description">Opis Produktu</label>
                        <textarea id="product-description" rows="3"></textarea>
                    </div>

                    <h3>2. Dodaj Kolory</h3>
                    <div class="color-input-group">
                        <input type="text" id="color-input" placeholder="Wpisz kolor (np. Czerwony)" required>
                        <button type="button" id="add-color-btn">DODAJ</button>
                    </div>
                    <ul id="color-list"></ul>
                    <p class="error-message" id="color-error"></p>
                    <button type="submit" id="data-form-next-btn">Dalej: Dodaj Obrazy</button>
                    <p class="error-message" id="product-data-error"></p>
                </form>
                
                <form id="image-upload-form" style="display: none;">
                    <h3>3. Dodaj Obraz dla ka≈ºdego koloru</h3>
                    <p>Musisz dodaƒá obraz dla nastƒôpujƒÖcych kolor√≥w:</p>
                    <ul id="image-upload-list"></ul>
                    <p class="error-message" id="image-error"></p>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="back-to-data-btn" style="flex: 1;">Wstecz</button>
                        <button type="submit" id="final-submit-btn" style="flex: 2;">DODAJ PRODUKT DO SKLEPU</button>
                    </div>
                </form>
            </div>
            
            <div id="manage-products-section" style="display: none;">
                <h3>Lista Produkt√≥w</h3>
                <div style="margin-bottom: 15px;">
                    <label for="manage-category-filter">Filtruj po kategorii:</label>
                    <select id="manage-category-filter" style="margin-left: 10px; padding: 5px;">
                        <option value="all">Wszystkie</option>
                        <option value="przedmioty">Przedmioty</option>
                        <option value="gad≈ºety">Gad≈ºety</option>
                    </select>
                </div>
                <ul id="product-management-list"></ul>
                <p id="no-products-message" style="text-align: center; color: #777; padding: 20px;">Brak produkt√≥w w sklepie.</p>
            </div>
        </div>
    </div>
    
    <!-- MODAL EDYCJI PRODUKTU -->
    <div class="modal" id="edit-product-modal">
        <div class="modal-content" style="max-width: 700px; text-align: left;">
            <span class="close-btn" id="close-edit-modal">&times;</span>
            <h2>Edytuj Produkt</h2>
            <form id="edit-product-data-form">
                <input type="hidden" id="edit-product-id">
                <h3>Podstawowe Dane</h3>
                <div class="admin-form-group">
                    <label for="edit-product-category">Kategoria</label>
                    <select id="edit-product-category" required>
                        <option value="przedmioty">Przedmioty</option>
                        <option value="gad≈ºety">Gad≈ºety</option>
                    </select>
                </div>
                <div class="admin-form-group">
                    <label for="edit-product-name">Nazwa Produktu</label>
                    <input type="text" id="edit-product-name" required>
                </div>
                <div class="admin-form-group">
                    <label for="edit-product-price">Cena (z≈Ç)</label>
                    <input type="number" id="edit-product-price" min="0.01" step="0.01" required>
                </div>
                <div class="admin-form-group">
                    <label for="edit-product-description">Opis Produktu</label>
                    <textarea id="edit-product-description" rows="3"></textarea>
                </div>
                <h3>Kolory i Obrazy</h3>
                <div id="edit-colors-container"></div>
                <button type="button" id="add-new-color-btn" class="add-new-color-btn">+ Dodaj nowy kolor</button>
                <p class="error-message" id="edit-image-error"></p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" id="cancel-edit-btn" style="flex: 1; background-color: #6c757d;">Anuluj</button>
                    <button type="submit" style="flex: 2;">ZAPISZ ZMIANY PRODUKTU</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL KOD√ìW RABATOWYCH -->
    <div class="modal" id="discount-codes-modal">
        <div class="modal-content" style="max-width: 700px; text-align: left;">
            <span class="close-btn" id="close-discount-codes">&times;</span>
            <h2>ZarzƒÖdzanie Kodami Rabatowymi</h2>
            
            <div class="admin-form-selector" style="margin-bottom: 20px;">
                <button type="button" id="add-code-tab" class="active">Dodaj Kod</button>
                <button type="button" id="manage-codes-tab">ZarzƒÖdzaj Kodami</button>
            </div>
            
            <div id="add-code-section" style="display: block;">
                <form id="discount-code-form">
                    <div class="admin-form-group">
                        <label for="code-name">Nazwa kodu*</label>
                        <input type="text" id="code-name" placeholder="np. WAKACJE2025" required 
                               style="text-transform: uppercase">
                        <small>Kod musi byƒá unikalny, tylko wielkie litery i cyfry</small>
                    </div>
                    <div class="admin-form-group">
                        <label for="code-discount">Rabat (%)*</label>
                        <input type="number" id="code-discount" min="1" max="100" 
                               placeholder="np. 20" required>
                        <small>Warto≈õƒá od 1% do 100%</small>
                    </div>
                    <div class="admin-form-group">
                        <label for="code-uses">Liczba u≈ºyƒá*</label>
                        <input type="number" id="code-uses" min="0" 
                               placeholder="np. 100 (0 = nieograniczony)" required>
                        <small>0 = nieograniczona liczba u≈ºyƒá</small>
                    </div>
                    <div class="admin-form-group">
                        <label for="code-start-date">Data rozpoczƒôcia*</label>
                        <input type="date" id="code-start-date" required>
                    </div>
                    <div class="admin-form-group">
                        <label for="code-end-date">Data zako≈Ñczenia*</label>
                        <input type="date" id="code-end-date" required>
                    </div>
                    <div class="admin-form-group">
                        <label for="code-minimum-amount">Minimalna kwota zam√≥wienia (z≈Ç)</label>
                        <input type="number" id="code-minimum-amount" min="0" step="0.01" 
                               placeholder="0.00 (brak limitu)">
                        <small>0.00 = brak minimalnej kwoty</small>
                    </div>
                    <div class="admin-form-group">
                        <label>
                            <input type="checkbox" id="code-active" checked> Kod aktywny
                        </label>
                    </div>
                    <p class="error-message" id="discount-code-error"></p>
                    <button type="submit">DODAJ KOD RABATOWY</button>
                </form>
            </div>
            
            <div id="manage-codes-section" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <label for="code-status-filter">Filtruj po statusie:</label>
                    <select id="code-status-filter" style="margin-left: 10px; padding: 5px;">
                        <option value="all">Wszystkie</option>
                        <option value="active">Aktywne</option>
                        <option value="inactive">Nieaktywne</option>
                        <option value="expired">Wygas≈Çe</option>
                        <option value="used_up">Wyczerpane</option>
                    </select>
                </div>
                <div id="discount-codes-list"></div>
                <p id="no-codes-message" style="text-align: center; color: #777; padding: 20px;">
                    Brak kod√≥w rabatowych.
                </p>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="notification"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- INICJALIZACJA ---
            const profilePhotoContainer = document.querySelector('.profile-picture-container');
            const profilePhoto = document.getElementById('profile-photo');
            const photoUploadInput = document.getElementById('photo-upload-input');
            const profileUsername = document.getElementById('profile-username');
            const profileEmail = document.getElementById('profile-email');
            const navProfilePhoto = document.getElementById('nav-profile-photo');
            const adminPanelBtn = document.getElementById('admin-panel-btn');
            const discountCodesBtn = document.getElementById('discount-codes-btn');
            const logoutNavLink = document.getElementById('logout-nav-link');
            const logoutCenterLink = document.getElementById('logout-center-link');
            const notification = document.getElementById('toast-notification');
            const accountDropdown = document.getElementById('account-dropdown');
            const accountIcon = document.getElementById('account-icon');
            const cartIcon = document.querySelector('.cart');

            // Modale profilu
            const passwordModal = document.getElementById('password-modal');
            const closePasswordModal = document.getElementById('close-password-modal');
            const passwordForm = document.getElementById('password-form');
            const changePasswordBtn = document.getElementById('change-password-btn');
            const emailModal = document.getElementById('email-modal');
            const closeEmailModal = document.getElementById('close-email-modal');
            const emailForm = document.getElementById('email-form');
            const changeEmailBtn = document.getElementById('change-email-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const deleteAccountBtn = document.getElementById('delete-account-btn');

            // Panel Admina - Produkty
            const adminPanelModal = document.getElementById('admin-panel-modal');
            const closeAdminPanel = document.getElementById('close-admin-panel');
            const addProductTab = document.getElementById('add-product-tab');
            const manageProductsTab = document.getElementById('manage-products-tab');
            const addProductSection = document.getElementById('add-product-section');
            const manageProductsSection = document.getElementById('manage-products-section');
            const productManagementList = document.getElementById('product-management-list');
            const noProductsMessage = document.getElementById('no-products-message');
            const categoryFilter = document.getElementById('manage-category-filter');
            const productDataForm = document.getElementById('product-data-form');
            const imageUploadForm = document.getElementById('image-upload-form');
            const colorInput = document.getElementById('color-input');
            const addColorBtn = document.getElementById('add-color-btn');
            const colorList = document.getElementById('color-list');
            const imageUploadList = document.getElementById('image-upload-list');
            const backToDataBtn = document.getElementById('back-to-data-btn');
            const colorError = document.getElementById('color-error');
            const imageError = document.getElementById('image-error');
            const productDataError = document.getElementById('product-data-error');
            const editProductModal = document.getElementById('edit-product-modal');
            const closeEditModal = document.getElementById('close-edit-modal');
            const editProductDataForm = document.getElementById('edit-product-data-form');
            const editColorsContainer = document.getElementById('edit-colors-container');
            const addNewColorBtn = document.getElementById('add-new-color-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const editImageError = document.getElementById('edit-image-error');

            // Panel Admina - Kody Rabatowe
            const discountCodesModal = document.getElementById('discount-codes-modal');
            const closeDiscountCodes = document.getElementById('close-discount-codes');
            const addCodeTab = document.getElementById('add-code-tab');
            const manageCodesTab = document.getElementById('manage-codes-tab');
            const addCodeSection = document.getElementById('add-code-section');
            const manageCodesSection = document.getElementById('manage-codes-section');
            const discountCodeForm = document.getElementById('discount-code-form');
            const discountCodesList = document.getElementById('discount-codes-list');
            const noCodesMessage = document.getElementById('no-codes-message');
            const codeStatusFilter = document.getElementById('code-status-filter');
            const discountCodeError = document.getElementById('discount-code-error');
            const codeNameInput = document.getElementById('code-name');
            const codeDiscountInput = document.getElementById('code-discount');
            const codeUsesInput = document.getElementById('code-uses');
            const codeStartDateInput = document.getElementById('code-start-date');
            const codeEndDateInput = document.getElementById('code-end-date');
            const codeMinAmountInput = document.getElementById('code-minimum-amount');
            const codeActiveInput = document.getElementById('code-active');

            // --- STAN GLOBALNY ---
            let loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            let cart = JSON.parse(localStorage.getItem('shoppingCart')) || [];
            let productDraft = { category: '', name: '', price: 0, description: '', colors: [] };
            let isEditMode = false;
            let currentEditProductId = null;
            
            // Przekierowanie je≈õli nie zalogowany
            if (!loggedInUser) {
                window.location.href = 'index.html';
                return;
            }

            // --- FUNKCJE POMOCNICZE ---
            function showNotification(message, isError = false) {
                notification.textContent = message;
                notification.classList.remove('error');
                if (isError) notification.classList.add('error');
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            }

            function updateLocalStorage(updatedUser) {
                const storedUsersString = localStorage.getItem('users');
                const users = storedUsersString ? JSON.parse(storedUsersString) : [];
                const oldEmail = loggedInUser.email;
                const index = users.findIndex(user => user.email.toLowerCase() === oldEmail.toLowerCase());
                if (index !== -1) {
                    users[index] = updatedUser;
                    localStorage.setItem('users', JSON.stringify(users));
                    loggedInUser = updatedUser;
                    sessionStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
                    loadProfileData();
                    return true;
                }
                return false;
            }

            function loadProfileData() {
                if (loggedInUser) {
                    profileUsername.textContent = loggedInUser.username;
                    profileEmail.textContent = loggedInUser.email;
                    document.getElementById('current-email').value = loggedInUser.email;
                    profilePhoto.src = loggedInUser.profilePicture || 'image_2245d8.png';
                    navProfilePhoto.src = loggedInUser.profilePicture || 'image_2245d8.png';
                    
                    const adminUsers = ['Exsi390', 'Admin'];
                    if (adminUsers.some(adminUser => loggedInUser.username.toLowerCase() === adminUser.toLowerCase())) {
                        adminPanelBtn.style.display = 'block';
                        discountCodesBtn.style.display = 'block';
                    } else {
                        adminPanelBtn.style.display = 'none';
                        discountCodesBtn.style.display = 'none';
                    }
                }
            }

            function handleLogout(event) {
                event.preventDefault();
                sessionStorage.removeItem('loggedInUser');
                loggedInUser = null;
                window.location.href = 'index.html';
            }

            // --- LOGIKA PROFILU ---
            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const currentPass = document.getElementById('current-pass').value;
                const newPass = document.getElementById('new-pass').value;
                const newPassConfirm = document.getElementById('new-pass-confirm').value;
                const passwordError = document.getElementById('password-error');
                passwordError.textContent = '';

                if (currentPass !== loggedInUser.password) {
                    passwordError.textContent = 'B≈Çƒôdne bie≈ºƒÖce has≈Ço.';
                    return;
                }
                if (newPass.length < 8) {
                    passwordError.textContent = 'Nowe has≈Ço musi mieƒá co najmniej 8 znak√≥w.';
                    return;
                }
                if (newPass !== newPassConfirm) {
                    passwordError.textContent = 'Nowe has≈Ça nie sƒÖ identyczne.';
                    return;
                }

                const updatedUser = { ...loggedInUser, password: newPass };
                if (updateLocalStorage(updatedUser)) {
                    passwordModal.style.display = 'none';
                    showNotification('Has≈Ço zosta≈Ço pomy≈õlnie zmienione!');
                    passwordForm.reset();
                } else {
                     showNotification('B≈ÇƒÖd aktualizacji danych.', true);
                }
            });

            emailForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const newEmail = document.getElementById('new-email').value;
                const emailPass = document.getElementById('email-pass').value;
                const emailError = document.getElementById('email-error');
                emailError.textContent = '';
                const storedUsersString = localStorage.getItem('users');
                const users = storedUsersString ? JSON.parse(storedUsersString) : [];

                if (emailPass !== loggedInUser.password) {
                    emailError.textContent = 'B≈Çƒôdne has≈Ço.';
                    return;
                }
                if (newEmail.toLowerCase() === loggedInUser.email.toLowerCase()) {
                    emailError.textContent = 'Nowy adres e-mail jest identyczny z bie≈ºƒÖcym.';
                    return;
                }
                if (users.some(user => user.email.toLowerCase() === newEmail.toLowerCase() && user.email.toLowerCase() !== loggedInUser.email.toLowerCase())) {
                    emailError.textContent = 'Konto z tym adresem e-mail ju≈º istnieje.';
                    return;
                }
                
                const updatedUser = { ...loggedInUser, email: newEmail };
                 if (updateLocalStorage(updatedUser)) {
                    emailModal.style.display = 'none';
                    showNotification('Adres e-mail zosta≈Ç pomy≈õlnie zmieniony!');
                    emailForm.reset();
                } else {
                     showNotification('B≈ÇƒÖd aktualizacji danych.', true);
                }
            });

            confirmDeleteBtn.addEventListener('click', function() {
                const storedUsersString = localStorage.getItem('users');
                let users = storedUsersString ? JSON.parse(storedUsersString) : [];
                users = users.filter(user => user.email.toLowerCase() !== loggedInUser.email.toLowerCase());
                localStorage.setItem('users', JSON.stringify(users));
                showNotification('Konto zosta≈Ço trwale usuniƒôte.');
                handleLogout(new Event('click'));
            });
            
            profilePhotoContainer.addEventListener('click', () => photoUploadInput.click());
            photoUploadInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64Image = e.target.result;
                        const updatedUser = { ...loggedInUser, profilePicture: base64Image };
                        updateLocalStorage(updatedUser);
                        showNotification('Zdjƒôcie profilowe zaktualizowane!');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // --- LOGIKA KOSZYKA ---
            function saveCart() {
                localStorage.setItem('shoppingCart', JSON.stringify(cart));
                updateCartCount();
            }

            function updateCartCount() {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                document.querySelectorAll('.cart-count').forEach(el => {
                    el.textContent = totalItems > 99 ? '99+' : totalItems;
                    el.style.display = totalItems > 0 ? 'block' : 'none';
                });
            }

            // --- PANEL ADMINA - PRODUKTY ---
            function getProducts() {
                const storedProductsString = localStorage.getItem('products');
                return storedProductsString ? JSON.parse(storedProductsString) : [];
            }
            
            function renderColorList() {
                colorList.innerHTML = productDraft.colors.map((color, index) => `
                    <li>
                        <span>${color.name}</span>
                        <button type="button" class="remove-color-btn" data-index="${index}">Usu≈Ñ</button>
                    </li>
                `).join('');
                colorList.querySelectorAll('.remove-color-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        productDraft.colors.splice(index, 1);
                        renderColorList();
                    });
                });
            }
            
            function renderImageUploadList(colors) {
                const listHTML = colors.map((color, index) => `
                    <li class="image-upload-item">
                        <img id="img-preview-${index}" src="${color.image || 'image_2245d8.png'}" alt="Obraz ${color.name}">
                        <label for="image-upload-${index}">${color.name}:</label>
                        <input type="file" id="image-upload-${index}" accept="image/*" data-index="${index}" required>
                    </li>
                `).join('');
                imageUploadList.innerHTML = listHTML;
                imageUploadList.querySelectorAll('input[type="file"]').forEach(input => {
                    input.addEventListener('change', handleImageUpload);
                });
            }
            
            function handleImageUpload(e) {
                const index = parseInt(e.target.dataset.index);
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64Image = e.target.result;
                        productDraft.colors[index].image = base64Image;
                        document.getElementById(`img-preview-${index}`).src = base64Image;
                        imageError.textContent = '';
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            function resetAdminForms() {
                productDraft = { category: '', name: '', price: 0, description: '', colors: [] };
                isEditMode = false;
                currentEditProductId = null;
                productDataForm.reset();
                imageUploadForm.reset();
                colorList.innerHTML = '';
                imageUploadList.innerHTML = '';
                colorError.textContent = '';
                imageError.textContent = '';
                productDataError.textContent = '';
            }

            function showAdminSection(section) {
                resetAdminForms();
                addProductTab.classList.remove('active');
                manageProductsTab.classList.remove('active');
                addProductSection.style.display = 'none';
                manageProductsSection.style.display = 'none';
                
                if (section === 'add') {
                    addProductTab.classList.add('active');
                    addProductSection.style.display = 'block';
                    productDataForm.style.display = 'block';
                    imageUploadForm.style.display = 'none';
                } else if (section === 'manage') {
                    manageProductsTab.classList.add('active');
                    manageProductsSection.style.display = 'block';
                    loadProductManagementList();
                }
            }
            
            addColorBtn.addEventListener('click', () => {
                colorError.textContent = '';
                const colorName = colorInput.value.trim();
                if (colorName === '') {
                    colorError.textContent = 'Pole koloru nie mo≈ºe byƒá puste.';
                    return;
                }
                const colorLower = colorName.toLowerCase();
                if (productDraft.colors.some(c => c.name.toLowerCase() === colorLower)) {
                    colorError.textContent = 'Ten kolor zosta≈Ç ju≈º dodany.';
                    return;
                }
                productDraft.colors.push({ name: colorName, image: '' });
                renderColorList();
                colorInput.value = '';
            });
            
            productDataForm.addEventListener('submit', (e) => {
                e.preventDefault();
                productDataError.textContent = '';
                colorError.textContent = '';
                if (productDraft.colors.length === 0) {
                    colorError.textContent = 'Musisz dodaƒá co najmniej jeden kolor.';
                    return;
                }
                const priceValue = parseFloat(document.getElementById('product-price').value);
                if (isNaN(priceValue) || priceValue <= 0) {
                     productDataError.textContent = 'Cena musi byƒá dodatniƒÖ liczbƒÖ.';
                     return;
                }
                productDraft.category = document.getElementById('product-category').value;
                productDraft.name = document.getElementById('product-name').value.trim();
                productDraft.price = priceValue;
                productDraft.description = document.getElementById('product-description').value.trim();
                if (productDraft.name === '') {
                    productDataError.textContent = 'Nazwa produktu nie mo≈ºe byƒá pusta.';
                    return;
                }
                productDataForm.style.display = 'none';
                imageUploadForm.style.display = 'block';
                renderImageUploadList(productDraft.colors);
            });

            backToDataBtn.addEventListener('click', () => {
                imageUploadForm.style.display = 'none';
                productDataForm.style.display = 'block';
            });
            
            imageUploadForm.addEventListener('submit', (e) => {
                e.preventDefault();
                imageError.textContent = '';
                const missingImage = productDraft.colors.find(c => c.image === '');
                if (missingImage) {
                    imageError.textContent = `Brak obrazu dla koloru: ${missingImage.name}`;
                    return;
                }
                const storedProductsString = localStorage.getItem('products');
                let products = storedProductsString ? JSON.parse(storedProductsString) : [];
                const newProduct = {
                    id: `prod-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    category: productDraft.category,
                    name: productDraft.name,
                    price: productDraft.price,
                    description: productDraft.description,
                    colors: productDraft.colors,
                    createdAt: new Date().toISOString()
                };
                products.push(newProduct);
                localStorage.setItem('products', JSON.stringify(products));
                showNotification(`Produkt "${newProduct.name}" zosta≈Ç pomy≈õlnie dodany do sklepu!`);
                adminPanelModal.style.display = 'none';
                resetAdminForms();
                showAdminSection('manage');
            });
            
            function loadProductManagementList() {
                const products = getProducts();
                const filterValue = categoryFilter.value;
                let filteredProducts = products;
                if (filterValue !== 'all') {
                    filteredProducts = products.filter(p => p.category === filterValue);
                }
                productManagementList.innerHTML = '';
                if (filteredProducts.length === 0) {
                    noProductsMessage.style.display = 'block';
                    return;
                }
                noProductsMessage.style.display = 'none';
                filteredProducts.forEach(product => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span style="flex: 1;">
                            <strong>${product.name}</strong><br>
                            <small>Kategoria: ${product.category} | Cena: ${product.price.toFixed(2)} z≈Ç</small><br>
                            <small>ID: ${product.id}</small>
                        </span>
                        <div class="product-actions">
                            <button class="edit-product-btn" data-id="${product.id}">EDYTUJ</button>
                            <button class="remove-product-btn" data-id="${product.id}">USU≈É</button>
                        </div>
                    `;
                    productManagementList.appendChild(li);
                });
                productManagementList.querySelectorAll('.remove-product-btn').forEach(button => {
                    button.addEventListener('click', handleRemoveProduct);
                });
                productManagementList.querySelectorAll('.edit-product-btn').forEach(button => {
                    button.addEventListener('click', handleEditProduct);
                });
            }
            
            function handleRemoveProduct(e) {
                const productId = e.target.dataset.id;
                if (!confirm('Czy na pewno chcesz usunƒÖƒá ten produkt?')) return;
                let products = getProducts();
                const productToRemove = products.find(p => p.id === productId);
                if (productToRemove) {
                    products = products.filter(p => p.id !== productId);
                    localStorage.setItem('products', JSON.stringify(products));
                    cart = cart.filter(item => item.id !== productId);
                    saveCart();
                    loadProductManagementList();
                    showNotification(`Produkt "${productToRemove.name}" zosta≈Ç usuniƒôty.`);
                } else {
                    showNotification('B≈ÇƒÖd: Nie znaleziono produktu do usuniƒôcia.', true);
                }
            }
            
            function handleEditProduct(e) {
                const productId = e.target.dataset.id;
                const products = getProducts();
                const product = products.find(p => p.id === productId);
                if (!product) {
                    showNotification('B≈ÇƒÖd: Nie znaleziono produktu do edycji.', true);
                    return;
                }
                currentEditProductId = productId;
                isEditMode = true;
                document.getElementById('edit-product-id').value = product.id;
                document.getElementById('edit-product-category').value = product.category;
                document.getElementById('edit-product-name').value = product.name;
                document.getElementById('edit-product-price').value = product.price;
                document.getElementById('edit-product-description').value = product.description || '';
                renderEditColors(product.colors);
                editProductModal.style.display = 'block';
            }
            
            function renderEditColors(colors) {
                editColorsContainer.innerHTML = colors.map((color, index) => `
                    <div class="edit-color-item" data-index="${index}">
                        <img id="edit-img-preview-${index}" src="${color.image || 'image_2245d8.png'}" alt="Obraz ${color.name}">
                        <div class="edit-color-info">
                            <div class="edit-color-name">${color.name}</div>
                            <input type="text" class="edit-color-name-input" value="${color.name}" placeholder="Nazwa koloru" style="width: 100%; padding: 5px; margin-bottom: 5px;">
                            <input type="file" class="edit-color-image-input" accept="image/*" data-index="${index}">
                        </div>
                        <div class="edit-color-actions">
                            <button type="button" class="remove-color-edit-btn" data-index="${index}">Usu≈Ñ</button>
                        </div>
                    </div>
                `).join('');
                editColorsContainer.querySelectorAll('.edit-color-name-input').forEach(input => {
                    input.addEventListener('change', function(e) {
                        const index = parseInt(e.target.closest('.edit-color-item').dataset.index);
                        const newName = e.target.value.trim();
                        if (newName) {
                            e.target.closest('.edit-color-item').querySelector('.edit-color-name').textContent = newName;
                        }
                    });
                });
                editColorsContainer.querySelectorAll('.edit-color-image-input').forEach(input => {
                    input.addEventListener('change', function(e) {
                        const index = parseInt(e.target.dataset.index);
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const base64Image = e.target.result;
                                document.getElementById(`edit-img-preview-${index}`).src = base64Image;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                });
                editColorsContainer.querySelectorAll('.remove-color-edit-btn').forEach(button => {
                    button.addEventListener('click', function(e) {
                        const index = parseInt(e.target.dataset.index);
                        const item = e.target.closest('.edit-color-item');
                        item.remove();
                    });
                });
            }
            
            addNewColorBtn.addEventListener('click', () => {
                const newIndex = editColorsContainer.children.length;
                const newColorItem = document.createElement('div');
                newColorItem.className = 'edit-color-item';
                newColorItem.dataset.index = newIndex;
                newColorItem.innerHTML = `
                    <img id="edit-img-preview-${newIndex}" src="image_2245d8.png" alt="Nowy kolor">
                    <div class="edit-color-info">
                        <div class="edit-color-name">Nowy kolor</div>
                        <input type="text" class="edit-color-name-input" value="Nowy kolor" placeholder="Nazwa koloru" style="width: 100%; padding: 5px; margin-bottom: 5px;">
                        <input type="file" class="edit-color-image-input" accept="image/*" data-index="${newIndex}">
                    </div>
                    <div class="edit-color-actions">
                        <button type="button" class="remove-color-edit-btn" data-index="${newIndex}">Usu≈Ñ</button>
                    </div>
                `;
                editColorsContainer.appendChild(newColorItem);
                newColorItem.querySelector('.edit-color-image-input').addEventListener('change', function(e) {
                    const index = parseInt(e.target.dataset.index);
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const base64Image = e.target.result;
                            document.getElementById(`edit-img-preview-${index}`).src = base64Image;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                newColorItem.querySelector('.remove-color-edit-btn').addEventListener('click', function(e) {
                    newColorItem.remove();
                });
            });
            
            editProductDataForm.addEventListener('submit', (e) => {
                e.preventDefault();
                editImageError.textContent = '';
                const updatedProduct = {
                    id: currentEditProductId,
                    category: document.getElementById('edit-product-category').value,
                    name: document.getElementById('edit-product-name').value.trim(),
                    price: parseFloat(document.getElementById('edit-product-price').value),
                    description: document.getElementById('edit-product-description').value.trim(),
                    colors: [],
                    createdAt: new Date().toISOString()
                };
                if (isNaN(updatedProduct.price) || updatedProduct.price <= 0) {
                    editImageError.textContent = 'Cena musi byƒá dodatniƒÖ liczbƒÖ.';
                    return;
                }
                if (updatedProduct.name === '') {
                    editImageError.textContent = 'Nazwa produktu nie mo≈ºe byƒá pusta.';
                    return;
                }
                const colorItems = editColorsContainer.querySelectorAll('.edit-color-item');
                if (colorItems.length === 0) {
                    editImageError.textContent = 'Produkt musi mieƒá co najmniej jeden kolor.';
                    return;
                }
                colorItems.forEach(item => {
                    const index = item.dataset.index;
                    const nameInput = item.querySelector('.edit-color-name-input');
                    const imageElement = item.querySelector(`#edit-img-preview-${index}`);
                    updatedProduct.colors.push({
                        name: nameInput.value.trim(),
                        image: imageElement.src
                    });
                });
                let products = getProducts();
                const index = products.findIndex(p => p.id === currentEditProductId);
                if (index !== -1) {
                    updatedProduct.createdAt = products[index].createdAt;
                    products[index] = updatedProduct;
                    localStorage.setItem('products', JSON.stringify(products));
                    showNotification(`Produkt "${updatedProduct.name}" zosta≈Ç pomy≈õlnie zaktualizowany.`);
                    editProductModal.style.display = 'none';
                    loadProductManagementList();
                    resetAdminForms();
                } else {
                    editImageError.textContent = 'B≈ÇƒÖd zapisu: Nie znaleziono produktu do aktualizacji.';
                }
            });

            // --- PANEL ADMINA - KODY RABATOWE ---
            function initializeDiscountCodes() {
                const storedCodes = localStorage.getItem('discountCodes');
                if (!storedCodes) {
                    const defaultCodes = [{
                        id: 'welcome10',
                        name: 'WELCOME10',
                        discount: 10,
                        maxUses: 100,
                        usedCount: 0,
                        startDate: '2024-01-01',
                        endDate: '2025-12-31',
                        minAmount: 0,
                        active: true,
                        createdAt: new Date().toISOString()
                    }];
                    localStorage.setItem('discountCodes', JSON.stringify(defaultCodes));
                }
            }

            function getDiscountCodes() {
                const storedCodes = localStorage.getItem('discountCodes');
                return storedCodes ? JSON.parse(storedCodes) : [];
            }

            function saveDiscountCodes(codes) {
                localStorage.setItem('discountCodes', JSON.stringify(codes));
            }

            function getCodeStatus(code) {
                const now = new Date();
                const startDate = new Date(code.startDate);
                const endDate = new Date(code.endDate);
                endDate.setHours(23, 59, 59, 999);
                if (!code.active) return 'inactive';
                if (now < startDate) return 'inactive';
                if (now > endDate) return 'expired';
                if (code.maxUses > 0 && code.usedCount >= code.maxUses) return 'used_up';
                return 'active';
            }

            function getStatusText(status) {
                const statusMap = {
                    'active': 'Aktywny',
                    'inactive': 'Nieaktywny',
                    'expired': 'Wygas≈Çy',
                    'used_up': 'Wyczerpany'
                };
                return statusMap[status] || status;
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('pl-PL');
            }

            function renderDiscountCodesList() {
                const codes = getDiscountCodes();
                const filterValue = codeStatusFilter.value;
                let filteredCodes = codes;
                if (filterValue !== 'all') {
                    filteredCodes = codes.filter(code => getCodeStatus(code) === filterValue);
                }
                discountCodesList.innerHTML = '';
                if (filteredCodes.length === 0) {
                    noCodesMessage.style.display = 'block';
                    return;
                }
                noCodesMessage.style.display = 'none';
                filteredCodes.forEach(code => {
                    const status = getCodeStatus(code);
                    const usagePercentage = code.maxUses > 0 ? (code.usedCount / code.maxUses) * 100 : 0;
                    const codeElement = document.createElement('div');
                    codeElement.className = 'discount-code-item';
                    codeElement.innerHTML = `
                        <div class="discount-code-header">
                            <div>
                                <span class="discount-code-name">${code.name}</span>
                                <span class="discount-code-status status-${status}">
                                    ${getStatusText(status)}
                                </span>
                            </div>
                            <div class="discount-code-discount">-${code.discount}%</div>
                        </div>
                        <div class="discount-code-details">
                            <div class="discount-code-detail">
                                <i>üìÖ</i> <span>Od: ${formatDate(code.startDate)}</span>
                            </div>
                            <div class="discount-code-detail">
                                <i>üìÖ</i> <span>Do: ${formatDate(code.endDate)}</span>
                            </div>
                            <div class="discount-code-detail">
                                <i>üî¢</i> <span>U≈ºycia: ${code.usedCount}/${code.maxUses > 0 ? code.maxUses : '‚àû'}</span>
                            </div>
                            <div class="discount-code-detail">
                                <i>üí∞</i> <span>Min. kwota: ${code.minAmount > 0 ? code.minAmount + ' z≈Ç' : 'Brak'}</span>
                            </div>
                        </div>
                        ${code.maxUses > 0 ? `
                            <div class="code-usage-bar">
                                <div class="code-usage-fill" style="width: ${usagePercentage}%"></div>
                            </div>
                        ` : ''}
                        <div class="discount-code-actions">
                            <button class="edit-code-btn" data-id="${code.id}">Edytuj</button>
                            <button class="remove-code-btn" data-id="${code.id}">Usu≈Ñ</button>
                        </div>
                    `;
                    discountCodesList.appendChild(codeElement);
                });
                discountCodesList.querySelectorAll('.edit-code-btn').forEach(button => {
                    button.addEventListener('click', handleEditDiscountCode);
                });
                discountCodesList.querySelectorAll('.remove-code-btn').forEach(button => {
                    button.addEventListener('click', handleRemoveDiscountCode);
                });
            }

            function handleRemoveDiscountCode(e) {
                const codeId = e.target.dataset.id;
                if (!confirm('Czy na pewno chcesz usunƒÖƒá ten kod rabatowy?')) return;
                let codes = getDiscountCodes();
                const codeToRemove = codes.find(c => c.id === codeId);
                if (codeToRemove) {
                    codes = codes.filter(c => c.id !== codeId);
                    saveDiscountCodes(codes);
                    renderDiscountCodesList();
                    showNotification(`Kod "${codeToRemove.name}" zosta≈Ç usuniƒôty.`);
                } else {
                    showNotification('B≈ÇƒÖd: Nie znaleziono kodu do usuniƒôcia.', true);
                }
            }

            function handleEditDiscountCode(e) {
                const codeId = e.target.dataset.id;
                const codes = getDiscountCodes();
                const code = codes.find(c => c.id === codeId);
                if (!code) {
                    showNotification('B≈ÇƒÖd: Nie znaleziono kodu do edycji.', true);
                    return;
                }
                // Wype≈Çnij formularz danymi kodu
                codeNameInput.value = code.name;
                codeDiscountInput.value = code.discount;
                codeUsesInput.value = code.maxUses;
                codeStartDateInput.value = code.startDate;
                codeEndDateInput.value = code.endDate;
                codeMinAmountInput.value = code.minAmount;
                codeActiveInput.checked = code.active;
                
                // Prze≈ÇƒÖcz na zak≈Çadkƒô dodawania
                addCodeTab.click();
                
                // Zmie≈Ñ przycisk na "ZAPISZ ZMIANY"
                const submitBtn = discountCodeForm.querySelector('button[type="submit"]');
                submitBtn.textContent = 'ZAPISZ ZMIANY';
                submitBtn.dataset.editId = codeId;
                
                showNotification(`Edytujesz kod: ${code.name}`);
            }

            function showDiscountCodesSection(section) {
                addCodeTab.classList.remove('active');
                manageCodesTab.classList.remove('active');
                addCodeSection.style.display = 'none';
                manageCodesSection.style.display = 'none';
                
                if (section === 'add') {
                    addCodeTab.classList.add('active');
                    addCodeSection.style.display = 'block';
                } else if (section === 'manage') {
                    manageCodesTab.classList.add('active');
                    manageCodesSection.style.display = 'block';
                    renderDiscountCodesList();
                }
            }

            discountCodeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                discountCodeError.textContent = '';
                
                const name = codeNameInput.value.trim().toUpperCase();
                const discount = parseInt(codeDiscountInput.value);
                const maxUses = parseInt(codeUsesInput.value);
                const startDate = codeStartDateInput.value;
                const endDate = codeEndDateInput.value;
                const minAmount = parseFloat(codeMinAmountInput.value) || 0;
                const active = codeActiveInput.checked;
                const isEditing = this.querySelector('button[type="submit"]').dataset.editId;
                
                // Walidacja
                if (!/^[A-Z0-9]+$/.test(name)) {
                    discountCodeError.textContent = 'Nazwa kodu mo≈ºe zawieraƒá tylko wielkie litery i cyfry.';
                    return;
                }
                if (discount < 1 || discount > 100) {
                    discountCodeError.textContent = 'Rabat musi byƒá w zakresie 1-100%.';
                    return;
                }
                if (maxUses < 0) {
                    discountCodeError.textContent = 'Liczba u≈ºyƒá nie mo≈ºe byƒá ujemna.';
                    return;
                }
                if (startDate >= endDate) {
                    discountCodeError.textContent = 'Data zako≈Ñczenia musi byƒá p√≥≈∫niejsza ni≈º data rozpoczƒôcia.';
                    return;
                }
                if (minAmount < 0) {
                    discountCodeError.textContent = 'Minimalna kwota nie mo≈ºe byƒá ujemna.';
                    return;
                }
                
                let codes = getDiscountCodes();
                
                // Sprawd≈∫ unikalno≈õƒá nazwy (tylko je≈õli nie edytujemy tego samego kodu)
                if (codes.some(c => c.name === name && (!isEditing || c.id !== isEditing))) {
                    discountCodeError.textContent = 'Kod o tej nazwie ju≈º istnieje.';
                    return;
                }
                
                if (isEditing) {
                    // Edycja istniejƒÖcego kodu
                    const index = codes.findIndex(c => c.id === isEditing);
                    if (index !== -1) {
                        codes[index] = {
                            ...codes[index],
                            name: name,
                            discount: discount,
                            maxUses: maxUses,
                            startDate: startDate,
                            endDate: endDate,
                            minAmount: minAmount,
                            active: active
                        };
                        saveDiscountCodes(codes);
                        showNotification(`Kod "${name}" zosta≈Ç zaktualizowany.`);
                    }
                } else {
                    // Dodawanie nowego kodu
                    const newCode = {
                        id: `code-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        name: name,
                        discount: discount,
                        maxUses: maxUses,
                        usedCount: 0,
                        startDate: startDate,
                        endDate: endDate,
                        minAmount: minAmount,
                        active: active,
                        createdAt: new Date().toISOString()
                    };
                    codes.push(newCode);
                    saveDiscountCodes(codes);
                    showNotification(`Kod rabatowy "${name}" zosta≈Ç dodany!`);
                }
                
                // Resetuj formularz
                discountCodeForm.reset();
                const submitBtn = discountCodeForm.querySelector('button[type="submit"]');
                submitBtn.textContent = 'DODAJ KOD RABATOWY';
                delete submitBtn.dataset.editId;
                
                // Prze≈ÇƒÖcz na listƒô
                showDiscountCodesSection('manage');
            });

            // --- INICJALIZACJA I LISTENERY ---
            initializeDiscountCodes();
            loadProfileData();
            updateCartCount();
            
            // Ustaw dzisiejszƒÖ datƒô jako domy≈õlnƒÖ dla kod√≥w
            const today = new Date().toISOString().split('T')[0];
            codeStartDateInput.value = today;
            codeEndDateInput.value = new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0];
            
            // Przyciski profilu
            changePasswordBtn.addEventListener('click', () => passwordModal.style.display = 'block');
            changeEmailBtn.addEventListener('click', () => emailModal.style.display = 'block');
            deleteAccountBtn.addEventListener('click', () => confirmModal.style.display = 'block');
            logoutNavLink.addEventListener('click', handleLogout);
            logoutCenterLink.addEventListener('click', handleLogout);
            
            // Panel Admina - Produkty
            adminPanelBtn.addEventListener('click', () => {
                adminPanelModal.style.display = 'block';
                showAdminSection('add');
            });
            closeAdminPanel.addEventListener('click', () => {
                adminPanelModal.style.display = 'none';
                resetAdminForms();
            });
            addProductTab.addEventListener('click', () => showAdminSection('add'));
            manageProductsTab.addEventListener('click', () => showAdminSection('manage'));
            categoryFilter.addEventListener('change', loadProductManagementList);
            
            // Panel Admina - Kody Rabatowe
            discountCodesBtn.addEventListener('click', () => {
                discountCodesModal.style.display = 'block';
                showDiscountCodesSection('add');
            });
            closeDiscountCodes.addEventListener('click', () => {
                discountCodesModal.style.display = 'none';
                discountCodeForm.reset();
                const submitBtn = discountCodeForm.querySelector('button[type="submit"]');
                submitBtn.textContent = 'DODAJ KOD RABATOWY';
                delete submitBtn.dataset.editId;
            });
            addCodeTab.addEventListener('click', () => showDiscountCodesSection('add'));
            manageCodesTab.addEventListener('click', () => showDiscountCodesSection('manage'));
            codeStatusFilter.addEventListener('change', renderDiscountCodesList);
            
            // Zamykanie modali
            closePasswordModal.addEventListener('click', () => { passwordModal.style.display = 'none'; passwordForm.reset(); });
            closeEmailModal.addEventListener('click', () => { emailModal.style.display = 'none'; emailForm.reset(); });
            closeEditModal.addEventListener('click', () => { editProductModal.style.display = 'none'; resetAdminForms(); });
            cancelEditBtn.addEventListener('click', () => { editProductModal.style.display = 'none'; resetAdminForms(); });

            window.addEventListener('click', function(event) {
                if (event.target === passwordModal) passwordModal.style.display = 'none';
                if (event.target === emailModal) emailModal.style.display = 'none';
                if (event.target === confirmModal) confirmModal.style.display = 'none';
                if (event.target === editProductModal) editProductModal.style.display = 'none';
                if (event.target === adminPanelModal) { 
                    adminPanelModal.style.display = 'none'; 
                    resetAdminForms(); 
                }
                if (event.target === discountCodesModal) { 
                    discountCodesModal.style.display = 'none';
                    discountCodeForm.reset();
                    const submitBtn = discountCodeForm.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'DODAJ KOD RABATOWY';
                    delete submitBtn.dataset.editId;
                }
                if (!accountIcon.contains(event.target)) {
                    accountDropdown.classList.remove('visible');
                }
            });
        });
    </script>
</body>
</html>